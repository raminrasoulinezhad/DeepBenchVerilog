This repository provide a framework to have a hls tool for RNNs. this readme file helps you to use the codes.

1- download the repo, and install an appropriate virtualenvironment using conda:

	git clone richarao/hls4ml/tree/keras-lstm
	cd hls4ml
	chmod +x ./install.sh
	./install.sh
	conda activate hls4ml-env

2- run hls4ml for a sample mode.

	cd test
	 ./keras-to-hls.sh -d ./projects  -t 'ap_fixed<8,4>'  KERAS_lstm_model

**Note:** model name should be any model located in `repo_addr/example-models/keras/*` wihtout `.json` or `_weight.h5`

after this line the files (CPP and Vivado HLS scripts) are ready for sysnthesis process in the project directory. This directory is automatically generated by the previous command. 

Let's synthesis the model:

	cd ./projects/project_dir
	vim build_prj.tcl

Let's turn the simulations off and turn the synthesis process on. change the process flags to do the synthesis and IP process:

csim <- 0
Synth <- 1
export <- 1
vsynth <- 1

then:

	vivado_hls -f build_prj.tcl

Note: it wroks for GRUs
but for lstm:

1- we need to modify `repo_addr/test/keras_to_hls.sh`. Add/modify these lines.

line 11 (add):

	maxloop=500

line 40 (add):

	echo "   -m maxloop"
	echo "      The maximum number of computation sequence in an RNN layer."

line 47 (modify):
	
	while getopts ":p:x:c:sr:g:t:d:m:h" opt; do


line 65 (add):

	m) maxloop=$OPTARG
		;;

line 108 (add):

	echo "MaxLoop: ${maxloop}" >> ${file}
	echo "" >> ${file}

2- Also the lstm layers requires to carry information about the sequences number in their cpp files. so, 

After using `keras-to-hls.sh` and generating c++ and vivado_hls files, we need to modify the missed informations: 

	cd project_dir/firmware/
	vim parameter.h

Now, add these informations to the config varibale of the lstm layers using `defines.h` parameters (let's say config3 relates to an lstm layer):

if in your keras model `return_sequences` is `False`:

	struct config3 : nnet::lstm_config {
		...
		static const unsigned n_sequence = N_LOOP_3;
		static const unsigned n_sequence_out = N_LOOP_3;
		...
	};

else:

	struct config3 : nnet::lstm_config {
		...
		static const unsigned n_sequence = N_LOOP_3;
		static const unsigned n_sequence_out = 1;
		...
	};
